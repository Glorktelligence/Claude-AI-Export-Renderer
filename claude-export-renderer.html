<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude AI Export Renderer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .header h1 {
            color: #f0f0f0;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .file-input-section {
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: #ff6b35;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .file-input-button:hover {
            background: #e55a2e;
        }

        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #333;
            display: none;
        }

        .search-box {
            width: calc(100% - 80px);
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px 0 0 8px;
            color: #e0e0e0;
            font-size: 16px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .search-button {
            width: 80px;
            padding: 12px;
            background: #ff6b35;
            border: 1px solid #ff6b35;
            border-radius: 0 8px 8px 0;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
            display: inline-block;
            vertical-align: top;
        }

        .search-button:hover {
            background: #e55a2e;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            color: #b0b0b0;
        }

        .filter-select {
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            min-width: 120px;
        }

        .stats {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b35;
        }

        .stat-label {
            font-size: 14px;
            color: #b0b0b0;
        }

        .conversations-list {
            display: none;
        }

        .conversation-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .conversation-item:hover {
            border-color: #444;
        }

        .conversation-header {
            background: #222;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-title {
            font-size: 18px;
            font-weight: 600;
            color: #f0f0f0;
        }

        .conversation-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #b0b0b0;
        }

        .conversation-content {
            display: none;
            padding: 20px;
        }

        .conversation-content.expanded {
            display: block;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid transparent;
        }

        .message.human {
            background: #1e2328;
            border-left-color: #4a9eff;
        }

        .message.assistant {
            background: #1a1e1a;
            border-left-color: #ff6b35;
        }

        .message-role {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .message.human .message-role {
            color: #4a9eff;
        }

        .message.assistant .message-role {
            color: #ff6b35;
        }

        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message-timestamp {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        .expand-toggle {
            background: none;
            border: none;
            color: #ff6b35;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.3s;
        }

        .expand-toggle.expanded {
            transform: rotate(180deg);
        }

        /* Individual conversation export button */
        .conversation-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-single-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        .conversation-header:hover .export-single-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .export-single-btn:hover {
            background: #2a5a8a;
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #b0b0b0;
        }

        .error {
            background: #2a1a1a;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4a2a2a;
            margin-bottom: 20px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .conversation-meta {
                flex-direction: column;
                gap: 5px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Highlight search matches */
        .highlight {
            background-color: #ff6b35;
            color: #000;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Code block styling */
        pre {
            background: #0a0a0a;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #333;
            margin: 10px 0;
        }

        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }

        /* Artifact styling */
        .artifact-container {
            margin: 10px 0;
            border: 1px solid #444;
            border-radius: 6px;
            overflow: hidden;
        }

        .artifact-header {
            background: #2a2a2a;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .artifact-header:hover {
            background: #333;
        }

        .artifact-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .artifact-toggle {
            color: #ff6b35;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .artifact-toggle.expanded {
            transform: rotate(180deg);
        }

        .artifact-icon {
            font-size: 16px;
        }

        .artifact-title {
            font-weight: 600;
            color: #f0f0f0;
        }

        .artifact-type {
            color: #ff6b35;
            font-size: 12px;
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: auto;
        }

        .artifact-content {
            display: none;
            background: #0a0a0a;
            padding: 12px;
            border-top: 1px solid #444;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .artifact-content.expanded {
            display: block;
            max-height: none;
        }

        .artifact-content.markdown-content {
            background: #1a1a1a;
            line-height: 1.6;
        }

        .artifact-content.markdown-content h1,
        .artifact-content.markdown-content h2,
        .artifact-content.markdown-content h3 {
            color: #f0f0f0;
            margin: 15px 0 10px 0;
        }

        .artifact-content.markdown-content h1 {
            font-size: 1.5em;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .artifact-content.markdown-content h2 {
            font-size: 1.3em;
        }

        .artifact-content.markdown-content h3 {
            font-size: 1.1em;
        }

        /* Collapsible code block styling */
        .collapsible-code-block {
            margin: 10px 0;
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
        }

        .code-block-header {
            background: #2a2a2a;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .code-block-header:hover {
            background: #333;
        }

        .code-block-label {
            font-size: 12px;
            color: #888;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .code-block-toggle {
            color: #ff6b35;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .code-block-toggle.expanded {
            transform: rotate(180deg);
        }

        .code-block-content {
            display: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .code-block-content.expanded {
            display: block;
            max-height: none;
        }

        .collapsible-code-block .code-block-content pre {
            margin: 0;
            border: none;
            border-radius: 0;
            border-top: 1px solid #333;
        }

        /* Settings Modal */
        .settings-btn {
            background: none;
            border: 1px solid #444;
            color: #888;
            cursor: pointer;
            font-size: 20px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .settings-btn:hover {
            background: #2a2a2a;
            color: #ff6b35;
            border-color: #ff6b35;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .modal-header h2 {
            color: #f0f0f0;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 24px;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #ff6b35;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group label {
            display: block;
            color: #b0b0b0;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .settings-group input[type="number"],
        .settings-group select {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .settings-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-description {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: #ff6b35;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #e55a2e;
        }

        .modal-btn.secondary {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        .modal-btn.secondary:hover {
            background: #3a3a3a;
        }

        /* Progress Indicator */
        .progress-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .progress-overlay.active {
            display: flex;
        }

        .progress-container {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            min-width: 300px;
        }

        .progress-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-text {
            color: #e0e0e0;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .progress-subtext {
            color: #888;
            font-size: 14px;
        }

        .footer {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-top: 40px;
            border: 1px solid #333;
            text-align: center;
            display: block;
        }

        .footer.hidden {
            display: none;
        }

        .footer p {
            margin: 5px 0;
            color: #b0b0b0;
            font-size: 14px;
        }

        .footer a {
            color: #ff6b35;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            display: none;
        }

        .pagination button {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #3a3a3a;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            color: #ff6b35;
            font-weight: bold;
        }

        .large-file-warning {
            background: #2a1a1a;
            color: #ffaa00;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4a3a2a;
            margin-bottom: 20px;
            display: none;
        }

        /* Selection Mode Styles */
        .selection-controls {
            display: none;
        }

        .selection-toggle-btn {
            background: #2a5a8a;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .selection-toggle-btn:hover {
            background: #3a6a9a;
        }

        .selection-toggle-btn.active {
            background: #ff6b35;
        }

        .selection-toggle-btn.active:hover {
            background: #e55a2e;
        }

        .bulk-actions-bar {
            display: none;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .bulk-actions-bar.active {
            display: flex;
        }

        .bulk-actions-bar .selection-count {
            color: #ff6b35;
            font-weight: 600;
            font-size: 16px;
        }

        .bulk-action-btn {
            background: #2a2a2a;
            color: #e0e0e0;
            padding: 8px 16px;
            border: 1px solid #444;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .bulk-action-btn:hover {
            background: #3a3a3a;
            border-color: #555;
        }

        .bulk-action-btn.primary {
            background: #ff6b35;
            border-color: #ff6b35;
        }

        .bulk-action-btn.primary:hover {
            background: #e55a2e;
        }

        .bulk-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .conversation-checkbox {
            display: none;
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 15px;
        }

        .selection-mode .conversation-checkbox {
            display: inline-block;
        }

        .conversation-header-left {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .conversation-header-content {
            flex: 1;
        }

        .export-buttons {
            display: none;
            gap: 10px;
            margin-bottom: 15px;
        }

        .export-btn {
            background: #2a5a8a;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .export-btn:hover {
            background: #3a6a9a;
        }

        .export-btn:disabled {
            background: #1a1a1a;
            color: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-i18n="main-title">Claude AI Export Renderer</h1>
            <p data-i18n="subtitle">Load and explore your Claude conversation exports with search, filtering, and clean formatting</p>
            
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                <div class="file-input-section">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".json" />
                        <button class="file-input-button" data-i18n="choose-file">Choose Claude Export File</button>
                    </div>
                    <div id="fileName" style="margin-top: 10px; color: #b0b0b0;"></div>
                </div>
                
                <div class="language-selector" style="display: flex; align-items: center;">
                    <select id="languageSelect" style="padding: 8px 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #e0e0e0;">
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="es">Español</option>
                        <option value="fr">Français</option>
                    </select>
                    <button id="settingsBtn" class="settings-btn" title="Export Settings">⚙️</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h2 data-i18n="settings-title">Export Settings</h2>
                    <button class="modal-close" id="closeSettings">×</button>
                </div>

                <div class="settings-group">
                    <label data-i18n="date-format-label">Date Format in Filename</label>
                    <select id="dateFormat">
                        <option value="YYYY-MM-DD" data-i18n="date-format-iso">YYYY-MM-DD (2024-10-26)</option>
                        <option value="DD-MM-YYYY" data-i18n="date-format-eu">DD-MM-YYYY (26-10-2024)</option>
                        <option value="MM-DD-YYYY" data-i18n="date-format-us">MM-DD-YYYY (10-26-2024)</option>
                        <option value="none" data-i18n="date-format-none">No Date</option>
                    </select>
                    <div class="settings-description" data-i18n="date-format-desc">Choose how dates appear in exported filenames</div>
                </div>

                <div class="settings-group">
                    <label data-i18n="title-length-label">Max Title Length in Filename</label>
                    <input type="number" id="titleLength" min="20" max="100" value="50" />
                    <div class="settings-description" data-i18n="title-length-desc">Maximum characters from conversation title in filename (20-100)</div>
                </div>

                <div class="settings-group">
                    <label data-i18n="json-indent-label">JSON Indentation</label>
                    <select id="jsonIndent">
                        <option value="2">2 spaces</option>
                        <option value="4">4 spaces</option>
                    </select>
                    <div class="settings-description" data-i18n="json-indent-desc">Spaces for JSON formatting (2 or 4)</div>
                </div>

                <div class="settings-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="includeTimestamp" checked />
                        <label for="includeTimestamp" data-i18n="include-timestamp-label">Include Time in Filename</label>
                    </div>
                    <div class="settings-description" data-i18n="include-timestamp-desc">Add timestamp to filename (e.g., 2024-10-26-14-30)</div>
                </div>

                <div class="modal-footer">
                    <button class="modal-btn secondary" id="resetSettings" data-i18n="reset-settings">Reset to Defaults</button>
                    <button class="modal-btn primary" id="saveSettings" data-i18n="save-settings">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div id="progressOverlay" class="progress-overlay">
            <div class="progress-container">
                <div class="progress-spinner"></div>
                <div class="progress-text" id="progressText" data-i18n="exporting">Exporting...</div>
                <div class="progress-subtext" id="progressSubtext"></div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="largeFileWarning" class="large-file-warning">
            <strong>Large File Detected!</strong> Your export is quite large. Pagination activated for better performance.
        </div>

        <div id="controls" class="controls">
            <input type="text" id="searchBox" class="search-box" data-i18n-placeholder="search-placeholder" placeholder="Search conversations and messages (press Enter)..." />
            
            <div class="filters">
                <div class="filter-group">
                    <label data-i18n="sort-by">Sort by:</label>
                    <select id="sortBy" class="filter-select">
                        <option value="date-desc" data-i18n="date-newest">Date (Newest First)</option>
                        <option value="date-asc" data-i18n="date-oldest">Date (Oldest First)</option>
                        <option value="title-asc" data-i18n="title-a-z">Title (A-Z)</option>
                        <option value="title-desc" data-i18n="title-z-a">Title (Z-A)</option>
                        <option value="messages-desc" data-i18n="most-messages">Most Messages</option>
                        <option value="messages-asc" data-i18n="fewest-messages">Fewest Messages</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label data-i18n="date-range">Date Range:</label>
                    <select id="dateFilter" class="filter-select">
                        <option value="all" data-i18n="all-time">All Time</option>
                        <option value="today" data-i18n="today">Today</option>
                        <option value="week" data-i18n="this-week">This Week</option>
                        <option value="month" data-i18n="this-month">This Month</option>
                        <option value="quarter" data-i18n="this-quarter">This Quarter</option>
                        <option value="year" data-i18n="this-year">This Year</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label data-i18n="show">Show:</label>
                    <select id="showFilter" class="filter-select">
                        <option value="all" data-i18n="all-conversations">All Conversations</option>
                        <option value="has-assistant" data-i18n="with-claude">With Claude Responses</option>
                        <option value="long" data-i18n="long-conversations">Long Conversations (10+ messages)</option>
                        <option value="recent" data-i18n="recently-updated">Recently Updated</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="stats" class="stats">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalConversations">0</div>
                    <div class="stat-label" data-i18n="total-conversations">Total Conversations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalMessages">0</div>
                    <div class="stat-label" data-i18n="total-messages">Total Messages</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dateRange">-</div>
                    <div class="stat-label" data-i18n="date-range-label">Date Range</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgMessages">0</div>
                    <div class="stat-label" data-i18n="avg-messages">Avg Messages/Chat</div>
                </div>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="export-buttons" id="exportButtons">
            <button id="exportFiltered" class="export-btn" data-i18n="export-filtered">
                Export Filtered Conversations
            </button>
        </div>

        <!-- Selection Mode Controls -->
        <div class="selection-controls" id="selectionControls">
            <button id="selectionToggle" class="selection-toggle-btn" data-i18n="enable-selection">
                Enable Selection Mode
            </button>
        </div>

        <!-- Bulk Actions Bar -->
        <div id="bulkActionsBar" class="bulk-actions-bar">
            <span class="selection-count" id="selectionCount">0 selected</span>
            <button id="selectAll" class="bulk-action-btn" data-i18n="select-all">
                Select All
            </button>
            <button id="selectAllVisible" class="bulk-action-btn" data-i18n="select-all-visible">
                Select All Visible
            </button>
            <button id="clearSelection" class="bulk-action-btn" data-i18n="clear-selection">
                Clear Selection
            </button>
            <button id="exportSelected" class="bulk-action-btn primary" data-i18n="export-selected" disabled>
                Export Selected
            </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Processing your Claude export...
        </div>

        <div id="pagination" class="pagination">
            <button id="firstPage" data-i18n="first">First</button>
            <button id="prevPage" data-i18n="previous">Previous</button>
            <span class="current-page"><span data-i18n="page">Page</span> <span id="currentPage">1</span> <span data-i18n="of">of</span> <span id="totalPages">1</span></span>
            <button id="nextPage" data-i18n="next">Next</button>
            <button id="lastPage" data-i18n="last">Last</button>
        </div>

        <div id="conversationsList" class="conversations-list"></div>

        <div id="pagination2" class="pagination">
            <button id="firstPage2" data-i18n="first">First</button>
            <button id="prevPage2" data-i18n="previous">Previous</button>
            <span class="current-page"><span data-i18n="page">Page</span> <span id="currentPage2">1</span> <span data-i18n="of">of</span> <span id="totalPages2">1</span></span>
            <button id="nextPage2" data-i18n="next">Next</button>
            <button id="lastPage2" data-i18n="last">Last</button>
        </div>
    </div>

    <div id="footer" class="footer">
        <p><strong data-i18n="footer-title">Claude AI Export Renderer</strong> - <span data-i18n="footer-subtitle">Built for exploring your Claude conversation history</span></p>
        <p data-i18n="footer-features">Features: Search, filter, artifact rendering, and pagination for large exports</p>
        <p data-i18n="footer-issues">Having issues? Check the browser console (F12) for debugging info</p>
        <p data-i18n="footer-community">Created with ❤️ for the Claude community</p>
        <p data-i18n="footer-collaboration">Developed collaboratively to handle large conversation exports</p>
    </div>

    <script>
        // Internationalization support
        const translations = {
            en: {
                'main-title': 'Claude AI Export Renderer',
                'subtitle': 'Load and explore your Claude conversation exports with search, filtering, and clean formatting',
                'choose-file': 'Choose Claude Export File',
                'search-placeholder': 'Search conversations and messages (press Enter)...',
                'sort-by': 'Sort by:',
                'date-newest': 'Date (Newest First)',
                'date-oldest': 'Date (Oldest First)',
                'title-a-z': 'Title (A-Z)',
                'title-z-a': 'Title (Z-A)',
                'most-messages': 'Most Messages',
                'fewest-messages': 'Fewest Messages',
                'date-range': 'Date Range:',
                'all-time': 'All Time',
                'today': 'Today',
                'this-week': 'This Week',
                'this-month': 'This Month',
                'this-quarter': 'This Quarter',
                'this-year': 'This Year',
                'show': 'Show:',
                'all-conversations': 'All Conversations',
                'with-claude': 'With Claude Responses',
                'long-conversations': 'Long Conversations (10+ messages)',
                'recently-updated': 'Recently Updated',
                'total-conversations': 'Total Conversations',
                'total-messages': 'Total Messages',
                'date-range-label': 'Date Range',
                'avg-messages': 'Avg Messages/Chat',
                'search-button': 'Search',
                'large-file-warning': 'Large File Detected! Your export is quite large. Pagination activated for better performance.',
                'processing': 'Processing your Claude export...',
                'no-results': 'No conversations found matching your criteria.',
                'page': 'Page',
                'of': 'of',
                'first': 'First',
                'previous': 'Previous',
                'next': 'Next',
                'last': 'Last',
                'footer-title': 'Claude AI Export Renderer',
                'footer-subtitle': 'Built for exploring your Claude conversation history',
                'footer-features': 'Features: Search, filter, artifact rendering, and pagination for large exports',
                'footer-issues': 'Having issues? Check the browser console (F12) for debugging info',
                'footer-community': 'Created with ❤️ for the Claude community',
                'footer-collaboration': 'Developed collaboratively to handle large conversation exports',
                'enable-selection': 'Enable Selection Mode',
                'disable-selection': 'Disable Selection Mode',
                'select-all': 'Select All',
                'select-all-visible': 'Select All Visible',
                'clear-selection': 'Clear Selection',
                'export-selected': 'Export Selected',
                'export-filtered': 'Export Filtered Conversations',
                'settings-title': 'Export Settings',
                'date-format-label': 'Date Format in Filename',
                'date-format-iso': 'YYYY-MM-DD (2024-10-26)',
                'date-format-eu': 'DD-MM-YYYY (26-10-2024)',
                'date-format-us': 'MM-DD-YYYY (10-26-2024)',
                'date-format-none': 'No Date',
                'date-format-desc': 'Choose how dates appear in exported filenames',
                'title-length-label': 'Max Title Length in Filename',
                'title-length-desc': 'Maximum characters from conversation title in filename (20-100)',
                'json-indent-label': 'JSON Indentation',
                'json-indent-desc': 'Spaces for JSON formatting (2 or 4)',
                'include-timestamp-label': 'Include Time in Filename',
                'include-timestamp-desc': 'Add timestamp to filename (e.g., 2024-10-26-14-30)',
                'reset-settings': 'Reset to Defaults',
                'save-settings': 'Save Settings',
                'exporting': 'Exporting...'
            },
            de: {
                'main-title': 'Claude AI Export Renderer',
                'subtitle': 'Laden und erkunden Sie Ihre Claude-Konversationsexporte mit Such-, Filter- und sauberen Formatierungsfunktionen',
                'choose-file': 'Claude-Exportdatei auswählen',
                'search-placeholder': 'Konversationen und Nachrichten durchsuchen (Enter drücken)...',
                'sort-by': 'Sortieren nach:',
                'date-newest': 'Datum (Neueste zuerst)',
                'date-oldest': 'Datum (Älteste zuerst)',
                'title-a-z': 'Titel (A-Z)',
                'title-z-a': 'Titel (Z-A)',
                'most-messages': 'Meiste Nachrichten',
                'fewest-messages': 'Wenigste Nachrichten',
                'date-range': 'Datumsbereich:',
                'all-time': 'Alle Zeit',
                'today': 'Heute',
                'this-week': 'Diese Woche',
                'this-month': 'Dieser Monat',
                'this-quarter': 'Dieses Quartal',
                'this-year': 'Dieses Jahr',
                'show': 'Anzeigen:',
                'all-conversations': 'Alle Konversationen',
                'with-claude': 'Mit Claude-Antworten',
                'long-conversations': 'Lange Konversationen (10+ Nachrichten)',
                'recently-updated': 'Kürzlich aktualisiert',
                'total-conversations': 'Gesamt Konversationen',
                'total-messages': 'Gesamt Nachrichten',
                'date-range-label': 'Datumsbereich',
                'avg-messages': 'Durchschn. Nachrichten/Chat',
                'search-button': 'Suchen',
                'large-file-warning': 'Große Datei erkannt! Ihr Export ist ziemlich groß. Paginierung für bessere Leistung aktiviert.',
                'processing': 'Verarbeitung Ihres Claude-Exports...',
                'no-results': 'Keine Konversationen gefunden, die Ihren Kriterien entsprechen.',
                'page': 'Seite',
                'of': 'von',
                'first': 'Erste',
                'previous': 'Vorherige',
                'next': 'Nächste',
                'last': 'Letzte',
                'footer-title': 'Claude AI Export Renderer',
                'footer-subtitle': 'Erstellt für die Erkundung Ihrer Claude-Konversationshistorie',
                'footer-features': 'Funktionen: Suche, Filter, Artefakt-Darstellung und Paginierung für große Exporte',
                'footer-issues': 'Probleme? Überprüfen Sie die Browser-Konsole (F12) für Debugging-Informationen',
                'footer-community': 'Mit ❤️ für die Claude-Community erstellt',
                'footer-collaboration': 'Kollaborativ entwickelt, um große Konversationsexporte zu handhaben',
                'enable-selection': 'Auswahlmodus aktivieren',
                'disable-selection': 'Auswahlmodus deaktivieren',
                'select-all': 'Alle auswählen',
                'select-all-visible': 'Alle sichtbaren auswählen',
                'clear-selection': 'Auswahl löschen',
                'export-selected': 'Ausgewählte exportieren',
                'export-filtered': 'Gefilterte Konversationen exportieren',
                'settings-title': 'Export-Einstellungen',
                'date-format-label': 'Datumsformat im Dateinamen',
                'date-format-iso': 'JJJJ-MM-TT (2024-10-26)',
                'date-format-eu': 'TT-MM-JJJJ (26-10-2024)',
                'date-format-us': 'MM-TT-JJJJ (10-26-2024)',
                'date-format-none': 'Kein Datum',
                'date-format-desc': 'Wählen Sie das Datumsformat für exportierte Dateinamen',
                'title-length-label': 'Max. Titellänge im Dateinamen',
                'title-length-desc': 'Maximale Zeichen vom Konversationstitel im Dateinamen (20-100)',
                'json-indent-label': 'JSON-Einrückung',
                'json-indent-desc': 'Leerzeichen für JSON-Formatierung (2 oder 4)',
                'include-timestamp-label': 'Zeit im Dateinamen einschließen',
                'include-timestamp-desc': 'Zeitstempel zum Dateinamen hinzufügen (z.B. 2024-10-26-14-30)',
                'reset-settings': 'Auf Standard zurücksetzen',
                'save-settings': 'Einstellungen speichern',
                'exporting': 'Exportiere...'
            },
            es: {
                'main-title': 'Claude AI Export Renderer',
                'subtitle': 'Carga y explora tus exportaciones de conversaciones de Claude con búsqueda, filtrado y formato limpio',
                'choose-file': 'Elegir archivo de exportación de Claude',
                'search-placeholder': 'Buscar conversaciones y mensajes (presiona Enter)...',
                'sort-by': 'Ordenar por:',
                'date-newest': 'Fecha (Más reciente primero)',
                'date-oldest': 'Fecha (Más antiguo primero)',
                'title-a-z': 'Título (A-Z)',
                'title-z-a': 'Título (Z-A)',
                'most-messages': 'Más mensajes',
                'fewest-messages': 'Menos mensajes',
                'date-range': 'Rango de fechas:',
                'all-time': 'Todo el tiempo',
                'today': 'Hoy',
                'this-week': 'Esta semana',
                'this-month': 'Este mes',
                'this-quarter': 'Este trimestre',
                'this-year': 'Este año',
                'show': 'Mostrar:',
                'all-conversations': 'Todas las conversaciones',
                'with-claude': 'Con respuestas de Claude',
                'long-conversations': 'Conversaciones largas (10+ mensajes)',
                'recently-updated': 'Recientemente actualizado',
                'total-conversations': 'Total de conversaciones',
                'total-messages': 'Total de mensajes',
                'date-range-label': 'Rango de fechas',
                'avg-messages': 'Promedio mensajes/chat',
                'search-button': 'Buscar',
                'large-file-warning': '¡Archivo grande detectado! Tu exportación es bastante grande. Paginación activada para mejor rendimiento.',
                'processing': 'Procesando tu exportación de Claude...',
                'no-results': 'No se encontraron conversaciones que coincidan con tus criterios.',
                'page': 'Página',
                'of': 'de',
                'first': 'Primera',
                'previous': 'Anterior',
                'next': 'Siguiente',
                'last': 'Última',
                'footer-title': 'Claude AI Export Renderer',
                'footer-subtitle': 'Construido para explorar tu historial de conversaciones de Claude',
                'footer-features': 'Características: Búsqueda, filtros, renderizado de artefactos y paginación para exportaciones grandes',
                'footer-issues': '¿Tienes problemas? Revisa la consola del navegador (F12) para información de depuración',
                'footer-community': 'Creado con ❤️ para la comunidad de Claude',
                'footer-collaboration': 'Desarrollado colaborativamente para manejar exportaciones de conversaciones grandes',
                'enable-selection': 'Activar modo de selección',
                'disable-selection': 'Desactivar modo de selección',
                'select-all': 'Seleccionar todas',
                'select-all-visible': 'Seleccionar todas las visibles',
                'clear-selection': 'Limpiar selección',
                'export-selected': 'Exportar seleccionadas',
                'export-filtered': 'Exportar conversaciones filtradas',
                'settings-title': 'Configuración de Exportación',
                'date-format-label': 'Formato de Fecha en el Nombre de Archivo',
                'date-format-iso': 'AAAA-MM-DD (2024-10-26)',
                'date-format-eu': 'DD-MM-AAAA (26-10-2024)',
                'date-format-us': 'MM-DD-AAAA (10-26-2024)',
                'date-format-none': 'Sin Fecha',
                'date-format-desc': 'Elige cómo aparecen las fechas en los nombres de archivo exportados',
                'title-length-label': 'Longitud Máxima del Título en el Nombre',
                'title-length-desc': 'Caracteres máximos del título de conversación en el nombre de archivo (20-100)',
                'json-indent-label': 'Indentación JSON',
                'json-indent-desc': 'Espacios para formato JSON (2 o 4)',
                'include-timestamp-label': 'Incluir Hora en el Nombre de Archivo',
                'include-timestamp-desc': 'Agregar marca de tiempo al nombre de archivo (ej. 2024-10-26-14-30)',
                'reset-settings': 'Restablecer Valores Predeterminados',
                'save-settings': 'Guardar Configuración',
                'exporting': 'Exportando...'
            },
            fr: {
                'main-title': 'Claude AI Export Renderer',
                'subtitle': 'Chargez et explorez vos exportations de conversations Claude avec recherche, filtrage et formatage propre',
                'choose-file': 'Choisir le fichier d\'exportation Claude',
                'search-placeholder': 'Rechercher des conversations et des messages (appuyez sur Entrée)...',
                'sort-by': 'Trier par :',
                'date-newest': 'Date (Plus récent d\'abord)',
                'date-oldest': 'Date (Plus ancien d\'abord)',
                'title-a-z': 'Titre (A-Z)',
                'title-z-a': 'Titre (Z-A)',
                'most-messages': 'Plus de messages',
                'fewest-messages': 'Moins de messages',
                'date-range': 'Plage de dates :',
                'all-time': 'Tout le temps',
                'today': 'Aujourd\'hui',
                'this-week': 'Cette semaine',
                'this-month': 'Ce mois',
                'this-quarter': 'Ce trimestre',
                'this-year': 'Cette année',
                'show': 'Afficher :',
                'all-conversations': 'Toutes les conversations',
                'with-claude': 'Avec réponses de Claude',
                'long-conversations': 'Conversations longues (10+ messages)',
                'recently-updated': 'Récemment mis à jour',
                'total-conversations': 'Total des conversations',
                'total-messages': 'Total des messages',
                'date-range-label': 'Plage de dates',
                'avg-messages': 'Moy. messages/chat',
                'search-button': 'Rechercher',
                'large-file-warning': 'Gros fichier détecté ! Votre exportation est assez volumineuse. Pagination activée pour de meilleures performances.',
                'processing': 'Traitement de votre exportation Claude...',
                'no-results': 'Aucune conversation trouvée correspondant à vos critères.',
                'page': 'Page',
                'of': 'de',
                'first': 'Première',
                'previous': 'Précédente',
                'next': 'Suivante',
                'last': 'Dernière',
                'footer-title': 'Claude AI Export Renderer',
                'footer-subtitle': 'Conçu pour explorer votre historique de conversations Claude',
                'footer-features': 'Fonctionnalités : Recherche, filtres, rendu d\'artefacts et pagination pour les gros exports',
                'footer-issues': 'Problèmes ? Vérifiez la console du navigateur (F12) pour les informations de débogage',
                'footer-community': 'Créé avec ❤️ pour la communauté Claude',
                'footer-collaboration': 'Développé en collaboration pour gérer les exportations de conversations volumineuses',
                'enable-selection': 'Activer le mode sélection',
                'disable-selection': 'Désactiver le mode sélection',
                'select-all': 'Tout sélectionner',
                'select-all-visible': 'Sélectionner tout le visible',
                'clear-selection': 'Effacer la sélection',
                'export-selected': 'Exporter la sélection',
                'export-filtered': 'Exporter les conversations filtrées',
                'settings-title': 'Paramètres d\'Exportation',
                'date-format-label': 'Format de Date dans le Nom de Fichier',
                'date-format-iso': 'AAAA-MM-JJ (2024-10-26)',
                'date-format-eu': 'JJ-MM-AAAA (26-10-2024)',
                'date-format-us': 'MM-JJ-AAAA (10-26-2024)',
                'date-format-none': 'Pas de Date',
                'date-format-desc': 'Choisissez comment les dates apparaissent dans les noms de fichiers exportés',
                'title-length-label': 'Longueur Max du Titre dans le Nom',
                'title-length-desc': 'Caractères maximum du titre de conversation dans le nom de fichier (20-100)',
                'json-indent-label': 'Indentation JSON',
                'json-indent-desc': 'Espaces pour le formatage JSON (2 ou 4)',
                'include-timestamp-label': 'Inclure l\'Heure dans le Nom de Fichier',
                'include-timestamp-desc': 'Ajouter l\'horodatage au nom de fichier (ex. 2024-10-26-14-30)',
                'reset-settings': 'Réinitialiser aux Valeurs par Défaut',
                'save-settings': 'Enregistrer les Paramètres',
                'exporting': 'Exportation en cours...'
            }
        };

        function setLanguage(lang) {
            // Update all elements with data-i18n attributes
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update placeholder text
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });

            // Update search button text
            const searchButton = document.querySelector('.search-button');
            if (searchButton && translations[lang]['search-button']) {
                searchButton.textContent = translations[lang]['search-button'];
            }

            // Store language preference
            localStorage.setItem('claude-renderer-language', lang);
        }

        function detectAndSetLanguage() {
            // Check stored preference first
            let savedLang = localStorage.getItem('claude-renderer-language');
            if (savedLang && translations[savedLang]) {
                document.getElementById('languageSelect').value = savedLang;
                setLanguage(savedLang);
                return;
            }

            // Auto-detect browser language
            const browserLang = navigator.language.toLowerCase();
            let detectedLang = 'en'; // default

            if (browserLang.startsWith('de')) detectedLang = 'de';
            else if (browserLang.startsWith('es')) detectedLang = 'es';
            else if (browserLang.startsWith('fr')) detectedLang = 'fr';

            document.getElementById('languageSelect').value = detectedLang;
            setLanguage(detectedLang);
        }

        class ClaudeExportRenderer {
            constructor() {
                this.conversations = [];
                this.filteredConversations = [];
                this.currentPage = 1;
                this.conversationsPerPage = 20; // Default page size
                // Selection mode state
                this.selectionMode = false;
                this.selectedConversations = new Set();
                // Export settings
                this.loadSettings();
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('fileInput').addEventListener('change', this.handleFileSelect.bind(this));
                
                // Language selector
                document.getElementById('languageSelect').addEventListener('change', (event) => {
                    setLanguage(event.target.value);
                });
                
                // Search on Enter key only, not on every keystroke
                const searchBox = document.getElementById('searchBox');
                searchBox.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        this.handleSearch(event);
                    }
                });
                
                // Add search button
                const searchButton = document.createElement('button');
                searchButton.textContent = 'Search';
                searchButton.className = 'search-button';
                searchButton.addEventListener('click', () => {
                    this.handleSearch({ target: { value: searchBox.value } });
                });
                searchBox.parentNode.insertBefore(searchButton, searchBox.nextSibling);
                
                document.getElementById('sortBy').addEventListener('change', this.handleFilterChange.bind(this));
                document.getElementById('dateFilter').addEventListener('change', this.handleFilterChange.bind(this));
                document.getElementById('showFilter').addEventListener('change', this.handleFilterChange.bind(this));

                // Selection mode event listeners
                document.getElementById('selectionToggle').addEventListener('click', this.toggleSelectionMode.bind(this));
                document.getElementById('selectAll').addEventListener('click', this.selectAll.bind(this));
                document.getElementById('selectAllVisible').addEventListener('click', this.selectAllVisible.bind(this));
                document.getElementById('clearSelection').addEventListener('click', this.clearSelection.bind(this));
                document.getElementById('exportSelected').addEventListener('click', this.exportSelected.bind(this));
                document.getElementById('exportFiltered').addEventListener('click', this.exportFiltered.bind(this));

                // Settings modal event listeners
                document.getElementById('settingsBtn').addEventListener('click', this.openSettings.bind(this));
                document.getElementById('closeSettings').addEventListener('click', this.closeSettings.bind(this));
                document.getElementById('saveSettings').addEventListener('click', this.saveSettings.bind(this));
                document.getElementById('resetSettings').addEventListener('click', this.resetSettings.bind(this));
                // Close modal on overlay click
                document.getElementById('settingsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'settingsModal') this.closeSettings();
                });

                // Pagination event listeners
                this.addPaginationListeners('');
                this.addPaginationListeners('2');
            }

            addPaginationListeners(suffix) {
                document.getElementById('firstPage' + suffix).addEventListener('click', () => this.goToPage(1));
                document.getElementById('prevPage' + suffix).addEventListener('click', () => this.goToPage(this.currentPage - 1));
                document.getElementById('nextPage' + suffix).addEventListener('click', () => this.goToPage(this.currentPage + 1));
                document.getElementById('lastPage' + suffix).addEventListener('click', () => this.goToPage(this.getTotalPages()));
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                document.getElementById('fileName').textContent = `Selected: ${file.name} (${this.formatFileSize(file.size)})`;
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';

                try {
                    const text = await this.readFile(file);
                    const data = JSON.parse(text);
                    this.processConversations(data);
                    this.showInterface();
                } catch (error) {
                    this.showError(`Error processing file: ${error.message}`);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }

            processConversations(data) {
                // Handle different export formats
                let conversations = [];
                
                if (Array.isArray(data)) {
                    conversations = data;
                } else if (data.conversations) {
                    conversations = data.conversations;
                } else if (data.data && Array.isArray(data.data)) {
                    conversations = data.data;
                } else {
                    throw new Error('Unrecognized export format');
                }

                this.conversations = conversations.map(conv => {
                    // Normalize conversation structure
                    const messages = conv.messages || conv.chat_messages || [];
                    const createdAt = conv.created_at || conv.created || conv.timestamp;
                    const updatedAt = conv.updated_at || conv.updated || conv.last_modified || createdAt;
                    
                    // Generate a better title if it's untitled
                    let title = conv.name || conv.title || 'Untitled Conversation';
                    if (title === 'Untitled Conversation' && messages.length > 0) {
                        // Try to get a meaningful title from the first human message
                        const firstHumanMessage = messages.find(msg => msg.role === 'human' || msg.role === 'user');
                        if (firstHumanMessage) {
                            const content = this.extractTextContent(firstHumanMessage.content);
                            if (content && content.length > 0) {
                                // Use first 50 characters as title
                                title = content.substring(0, 50).trim();
                                if (content.length > 50) title += '...';
                                // Clean up the title
                                title = title.replace(/\n/g, ' ').replace(/\s+/g, ' ');
                            }
                        }
                    }
                    
                    return {
                        ...conv,
                        id: conv.id || conv.uuid || this.generateId(),
                        name: title,
                        created_at: createdAt,
                        updated_at: updatedAt,
                        messages: messages.map(msg => ({
                            ...msg,
                            role: msg.role || msg.sender || 'unknown',
                            content: msg.content || msg.text || msg.message || '',
                            timestamp: msg.timestamp || msg.created_at
                        }))
                    };
                }).filter(conv => {
                    // Filter out conversations with no meaningful content
                    if (!conv.messages || conv.messages.length === 0) return false;
                    
                    // Check if any message has actual text content
                    const hasContent = conv.messages.some(msg => {
                        const content = this.extractTextContent(msg.content);
                        return content && content.trim().length > 0;
                    });
                    
                    return hasContent;
                });

                this.filteredConversations = [...this.conversations];
                this.updateStats();
                this.renderConversations();
            }

            generateId() {
                return Math.random().toString(36).substr(2, 9);
            }

            showInterface() {
                document.getElementById('controls').style.display = 'block';
                document.getElementById('stats').style.display = 'block';
                document.getElementById('conversationsList').style.display = 'block';
                // Show export and selection controls
                document.getElementById('exportButtons').style.display = 'flex';
                document.getElementById('selectionControls').style.display = 'block';

                // Hide footer when conversations are loaded
                document.getElementById('footer').classList.add('hidden');
                
                // Show large file warning if file is over 50MB or has over 500 conversations
                const fileSize = this.conversations.length * 1000; // Rough estimate
                if (this.conversations.length > 500 || fileSize > 50000) {
                    const warningElement = document.getElementById('largeFileWarning');
                    warningElement.style.display = 'block';
                    this.conversationsPerPage = 10; // Smaller page size for large files
                    
                    // Auto-hide warning after 7 seconds
                    setTimeout(() => {
                        warningElement.style.opacity = '0';
                        warningElement.style.transition = 'opacity 1s ease-out';
                        setTimeout(() => {
                            warningElement.style.display = 'none';
                        }, 1000); // Wait for fade-out to complete
                    }, 7000);
                } else if (this.conversations.length > 100) {
                    this.conversationsPerPage = 20;
                } else {
                    this.conversationsPerPage = 50; // Show more for smaller collections
                }
                
                // Show pagination if needed
                if (this.filteredConversations.length > this.conversationsPerPage) {
                    document.getElementById('pagination').style.display = 'flex';
                    document.getElementById('pagination2').style.display = 'flex';
                }
                
                this.updatePaginationControls();
            }

            getTotalPages() {
                return Math.ceil(this.filteredConversations.length / this.conversationsPerPage);
            }

            goToPage(page) {
                const totalPages = this.getTotalPages();
                if (page < 1) page = 1;
                if (page > totalPages) page = totalPages;
                
                this.currentPage = page;
                this.renderConversations();
                this.updatePaginationControls();
                
                // Scroll to top
                document.getElementById('conversationsList').scrollIntoView({ behavior: 'smooth' });
            }

            updatePaginationControls() {
                const totalPages = this.getTotalPages();
                const showPagination = totalPages > 1;
                
                document.getElementById('pagination').style.display = showPagination ? 'flex' : 'none';
                document.getElementById('pagination2').style.display = showPagination ? 'flex' : 'none';
                
                if (showPagination) {
                    // Update both pagination controls
                    ['', '2'].forEach(suffix => {
                        document.getElementById('currentPage' + suffix).textContent = this.currentPage;
                        document.getElementById('totalPages' + suffix).textContent = totalPages;
                        
                        document.getElementById('firstPage' + suffix).disabled = this.currentPage === 1;
                        document.getElementById('prevPage' + suffix).disabled = this.currentPage === 1;
                        document.getElementById('nextPage' + suffix).disabled = this.currentPage === totalPages;
                        document.getElementById('lastPage' + suffix).disabled = this.currentPage === totalPages;
                    });
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            updateStats() {
                const totalConversations = this.conversations.length;
                const totalMessages = this.conversations.reduce((sum, conv) => sum + conv.messages.length, 0);
                
                const dates = this.conversations
                    .map(conv => new Date(conv.created_at))
                    .filter(date => !isNaN(date))
                    .sort((a, b) => a - b);
                
                const dateRange = dates.length > 0 
                    ? `${this.formatDate(dates[0])} - ${this.formatDate(dates[dates.length - 1])}`
                    : 'Unknown';
                
                const avgMessages = totalConversations > 0 
                    ? Math.round(totalMessages / totalConversations)
                    : 0;

                document.getElementById('totalConversations').textContent = totalConversations.toLocaleString();
                document.getElementById('totalMessages').textContent = totalMessages.toLocaleString();
                document.getElementById('dateRange').textContent = dateRange;
                document.getElementById('avgMessages').textContent = avgMessages;
            }

            handleSearch(event) {
                const query = event.target.value.toLowerCase().trim();
                
                if (!query) {
                    this.filteredConversations = [...this.conversations];
                } else {
                    this.filteredConversations = this.conversations.filter(conv => {
                        const titleMatch = conv.name.toLowerCase().includes(query);
                        const messageMatch = conv.messages.some(msg => {
                            const content = this.extractTextContent(msg.content);
                            return content.toLowerCase().includes(query);
                        });
                        return titleMatch || messageMatch;
                    });
                }
                
                this.currentPage = 1; // Reset to first page
                this.applySorting();
                this.renderConversations();
            }

            handleFilterChange() {
                this.currentPage = 1; // Reset to first page
                this.applyFilters();
                this.applySorting();
                this.renderConversations();
            }

            applyFilters() {
                const dateFilter = document.getElementById('dateFilter').value;
                const showFilter = document.getElementById('showFilter').value;
                const searchQuery = document.getElementById('searchBox').value.toLowerCase().trim();
                
                let filtered = [...this.conversations];

                // Apply search filter
                if (searchQuery) {
                    filtered = filtered.filter(conv => {
                        const titleMatch = conv.name.toLowerCase().includes(searchQuery);
                        const messageMatch = conv.messages.some(msg => {
                            const content = this.extractTextContent(msg.content);
                            return content.toLowerCase().includes(searchQuery);
                        });
                        return titleMatch || messageMatch;
                    });
                }

                // Apply date filter
                if (dateFilter !== 'all') {
                    const now = new Date();
                    const filterDate = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            filterDate.setHours(0, 0, 0, 0);
                            break;
                        case 'week':
                            filterDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            filterDate.setMonth(now.getMonth() - 1);
                            break;
                        case 'quarter':
                            filterDate.setMonth(now.getMonth() - 3);
                            break;
                        case 'year':
                            filterDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }
                    
                    filtered = filtered.filter(conv => {
                        const convDate = new Date(conv.updated_at || conv.created_at);
                        return convDate >= filterDate;
                    });
                }

                // Apply show filter
                switch (showFilter) {
                    case 'has-assistant':
                        filtered = filtered.filter(conv => 
                            conv.messages.some(msg => msg.role === 'assistant')
                        );
                        break;
                    case 'long':
                        filtered = filtered.filter(conv => conv.messages.length >= 10);
                        break;
                    case 'recent':
                        const recentThreshold = new Date();
                        recentThreshold.setDate(recentThreshold.getDate() - 7);
                        filtered = filtered.filter(conv => {
                            const convDate = new Date(conv.updated_at || conv.created_at);
                            return convDate >= recentThreshold;
                        });
                        break;
                }

                this.filteredConversations = filtered;
            }

            applySorting() {
                const sortBy = document.getElementById('sortBy').value;
                
                this.filteredConversations.sort((a, b) => {
                    switch (sortBy) {
                        case 'date-desc':
                            return new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at);
                        case 'date-asc':
                            return new Date(a.updated_at || a.created_at) - new Date(b.updated_at || b.created_at);
                        case 'title-asc':
                            return a.name.localeCompare(b.name);
                        case 'title-desc':
                            return b.name.localeCompare(a.name);
                        case 'messages-desc':
                            return b.messages.length - a.messages.length;
                        case 'messages-asc':
                            return a.messages.length - b.messages.length;
                        default:
                            return 0;
                    }
                });
            }

            renderConversations() {
                const container = document.getElementById('conversationsList');
                
                if (this.filteredConversations.length === 0) {
                    container.innerHTML = '<div class="no-results">No conversations found matching your criteria.</div>';
                    this.updatePaginationControls();
                    return;
                }

                // Calculate pagination
                const totalPages = this.getTotalPages();
                const startIndex = (this.currentPage - 1) * this.conversationsPerPage;
                const endIndex = startIndex + this.conversationsPerPage;
                const conversationsToShow = this.filteredConversations.slice(startIndex, endIndex);

                container.innerHTML = conversationsToShow.map(conv => 
                    this.renderConversation(conv)
                ).join('');

                // Add event listeners for expand/collapse
                container.querySelectorAll('.conversation-header').forEach(header => {
                    header.addEventListener('click', this.toggleConversation.bind(this));
                });

                this.updatePaginationControls();
            }

            renderConversation(conversation) {
                const createdDate = this.formatDate(new Date(conversation.created_at));
                const updatedDate = this.formatDate(new Date(conversation.updated_at || conversation.created_at));
                const messageCount = conversation.messages.length;

                const messagesHtml = conversation.messages.map(msg =>
                    this.renderMessage(msg)
                ).join('');

                // Add checkbox if selection mode is active
                const checkbox = this.selectionMode ? `
                    <input
                        type="checkbox"
                        class="conversation-checkbox"
                        id="checkbox-${conversation.id}"
                        ${this.selectedConversations.has(conversation.id) ? 'checked' : ''}
                        onclick="event.stopPropagation(); app.toggleConversationSelection('${conversation.id}')"
                    />
                ` : '';

                return `
                    <div class="conversation-item" data-id="${conversation.id}">
                        <div class="conversation-header">
                            <div class="conversation-header-left">
                                ${checkbox}
                                <div class="conversation-header-content">
                                    <div class="conversation-title">${this.escapeHtml(conversation.name)}</div>
                                    <div class="conversation-meta">
                                        <span>Created: ${createdDate}</span>
                                        <span>Updated: ${updatedDate}</span>
                                        <span>${messageCount} messages</span>
                                    </div>
                                </div>
                            </div>
                            <div class="conversation-header-actions">
                                <button class="export-single-btn" onclick="event.stopPropagation(); app.exportSingleConversation('${conversation.id}')" title="Export this conversation">💾</button>
                                <button class="expand-toggle">▼</button>
                            </div>
                        </div>
                        <div class="conversation-content">
                            ${messagesHtml}
                        </div>
                    </div>
                `;
            }

            renderMessage(message) {
                const role = message.role || 'unknown';
                const content = this.formatMessageContent(message.content);
                const timestamp = message.timestamp ? this.formatDate(new Date(message.timestamp)) : '';
                
                return `
                    <div class="message ${role}">
                        <div class="message-role">${role}</div>
                        <div class="message-content">${content}</div>
                        ${timestamp ? `<div class="message-timestamp">${timestamp}</div>` : ''}
                    </div>
                `;
            }

            extractTextContent(content) {
                if (!content) return '';
                
                if (typeof content === 'string') {
                    // Try to parse as JSON if it looks like tool use data
                    if (content.trim().startsWith('{"start_timestamp"') || content.trim().startsWith('{"type"')) {
                        try {
                            const parsed = JSON.parse(content);
                            return this.extractFromParsedContent(parsed);
                        } catch (e) {
                            return content;
                        }
                    }
                    return content;
                } else if (Array.isArray(content)) {
                    // Handle arrays of mixed content
                    return content.map(item => this.extractTextContent(item)).filter(text => text).join(' ');
                } else if (typeof content === 'object') {
                    return this.extractFromParsedContent(content);
                } else {
                    return String(content);
                }
            }

            extractFromParsedContent(parsed) {
                if (!parsed) return '';
                
                // Handle arrays
                if (Array.isArray(parsed)) {
                    return parsed.map(item => this.extractFromParsedContent(item)).filter(text => text).join(' ');
                }
                
                // Handle tool use with artifacts
                if (parsed.type === 'tool_use' && parsed.name === 'artifacts' && parsed.input) {
                    const input = parsed.input;
                    let result = `[Artifact: ${input.title || input.id || 'Untitled'}]`;
                    if (input.content) {
                        result += ' ' + input.content;
                    }
                    return result;
                }
                
                // Handle other tool uses
                if (parsed.type === 'tool_use') {
                    let result = `[Tool: ${parsed.name}]`;
                    if (parsed.input && typeof parsed.input === 'object') {
                        if (parsed.input.query) result += ` Query: ${parsed.input.query}`;
                        if (parsed.input.content) result += ' ' + parsed.input.content;
                        if (parsed.input.url) result += ` URL: ${parsed.input.url}`;
                    }
                    return result;
                }
                
                // Handle text content - check for empty text specifically
                if (parsed.type === 'text') {
                    if (parsed.text && String(parsed.text).trim()) {
                        return parsed.text;
                    } else {
                        return ''; // Skip empty text blocks
                    }
                }
                
                // Handle other message types
                if (parsed.type === 'tool_result' && parsed.content) return `[Tool Result: ${parsed.content}]`;
                
                // Handle direct properties
                if (parsed.text && String(parsed.text).trim()) return parsed.text;
                if (parsed.content && String(parsed.content).trim()) return parsed.content;
                
                // Skip objects that don't contain meaningful text content
                return '';
            }

            formatMessageContent(content) {
                if (!content) return '';
                
                let parts = [];
                let hasArtifacts = false;
                
                if (typeof content === 'string') {
                    // Try to parse as JSON if it looks like tool use data
                    if (content.trim().startsWith('{"start_timestamp"') || content.trim().startsWith('{"type"')) {
                        try {
                            const parsed = JSON.parse(content);
                            const result = this.formatParsedContent(parsed);
                            parts.push(result);
                            if (result.isArtifact) hasArtifacts = true;
                        } catch (e) {
                            parts.push({ content: content, isArtifact: false, artifactType: '', artifactTitle: '' });
                        }
                    } else {
                        parts.push({ content: content, isArtifact: false, artifactType: '', artifactTitle: '' });
                    }
                } else if (Array.isArray(content)) {
                    // Handle arrays of mixed content
                    content.forEach(item => {
                        if (typeof item === 'string') {
                            if (item.trim()) {
                                parts.push({ content: item, isArtifact: false, artifactType: '', artifactTitle: '' });
                            }
                        } else if (typeof item === 'object') {
                            const result = this.formatParsedContent(item);
                            if (result.content && String(result.content).trim()) {
                                parts.push(result);
                                if (result.isArtifact) hasArtifacts = true;
                            }
                        }
                    });
                } else if (typeof content === 'object') {
                    const result = this.formatParsedContent(content);
                    parts.push(result);
                    if (result.isArtifact) hasArtifacts = true;
                } else {
                    parts.push({ content: String(content), isArtifact: false, artifactType: '', artifactTitle: '' });
                }
                
                // Format each part
                let formattedParts = parts.map(part => {
                    if (!part.content || !String(part.content).trim()) return '';
                    
                    let formatted = this.escapeHtml(String(part.content));
                    
                    if (part.isArtifact) {
                        const artifactId = 'artifact-' + Math.random().toString(36).substr(2, 9);
                        const header = `<div class="artifact-header" onclick="app.toggleArtifact('${artifactId}')">
                            <div class="artifact-header-left">
                                <span class="artifact-icon">📄</span>
                                <span class="artifact-title">${this.escapeHtml(part.artifactTitle)}</span>
                                <span class="artifact-type">${this.escapeHtml(part.artifactType)}</span>
                            </div>
                            <span class="artifact-toggle" id="${artifactId}-toggle">▼</span>
                        </div>`;

                        let content = '';
                        if (part.artifactType === 'text/markdown' || part.artifactType === 'markdown') {
                            content = '<div class="artifact-content markdown-content" id="' + artifactId + '">' + this.formatMarkdown(formatted) + '</div>';
                        } else if (part.artifactType === 'text/html' || part.artifactType === 'html') {
                            content = '<div class="artifact-content html-content" id="' + artifactId + '"><pre><code>' + formatted + '</code></pre></div>';
                        } else if (part.artifactType === 'text/javascript' || part.artifactType === 'javascript' || part.artifactType === 'code') {
                            content = '<div class="artifact-content code-content" id="' + artifactId + '"><pre><code>' + formatted + '</code></pre></div>';
                        } else {
                            content = '<div class="artifact-content" id="' + artifactId + '"><pre><code>' + formatted + '</code></pre></div>';
                        }

                        formatted = '<div class="artifact-container">' + header + content + '</div>';
                    } else {
                        // Regular content formatting
                        formatted = this.formatMarkdown(formatted);
                    }
                    
                    return formatted;
                }).filter(part => part && part.trim());
                
                let result = formattedParts.join('\n\n');
                
                // Highlight search matches
                const searchQuery = document.getElementById('searchBox').value.trim();
                if (searchQuery) {
                    const regex = new RegExp(`(${this.escapeRegex(searchQuery)})`, 'gi');
                    result = result.replace(regex, '<span class="highlight">$1</span>');
                }
                
                return result;
            }

            formatParsedContent(parsed) {
                if (!parsed) return { content: '', isArtifact: false, artifactType: '', artifactTitle: '' };
                
                // Handle tool use with artifacts
                if (parsed.type === 'tool_use' && parsed.name === 'artifacts' && parsed.input) {
                    const input = parsed.input;
                    return {
                        content: input.content || '[No content]',
                        isArtifact: true,
                        artifactType: input.type || 'unknown',
                        artifactTitle: input.title || input.id || 'Untitled Artifact'
                    };
                }
                
                // Handle other tool uses
                if (parsed.type === 'tool_use') {
                    let content = `🔧 Tool: ${parsed.name}\n`;
                    if (parsed.input && typeof parsed.input === 'object') {
                        if (parsed.input.query) content += `Query: ${parsed.input.query}\n`;
                        if (parsed.input.url) content += `URL: ${parsed.input.url}\n`;
                        if (parsed.input.content) content += parsed.input.content;
                        else {
                            // Show relevant input parameters
                            const relevantKeys = Object.keys(parsed.input).filter(key => 
                                key !== 'start_timestamp' && key !== 'stop_timestamp' && key !== 'flags'
                            );
                            if (relevantKeys.length > 0) {
                                content += relevantKeys.map(key => `${key}: ${parsed.input[key]}`).join('\n');
                            }
                        }
                    }
                    return { content, isArtifact: false, artifactType: '', artifactTitle: '' };
                }
                
                // Handle text content - check for empty text specifically
                if (parsed.type === 'text') {
                    const text = parsed.text || '';
                    if (String(text).trim()) {
                        return { content: text, isArtifact: false, artifactType: '', artifactTitle: '' };
                    } else {
                        return { content: '', isArtifact: false, artifactType: '', artifactTitle: '' };
                    }
                }
                
                // Handle arrays
                if (Array.isArray(parsed)) {
                    const contents = parsed.map(item => this.formatParsedContent(item).content).filter(c => c.trim());
                    return { content: contents.join('\n\n'), isArtifact: false, artifactType: '', artifactTitle: '' };
                }
                
                // Handle direct properties
                if (parsed.text && String(parsed.text).trim()) {
                    return { content: parsed.text, isArtifact: false, artifactType: '', artifactTitle: '' };
                }
                if (parsed.content && String(parsed.content).trim()) {
                    return { content: parsed.content, isArtifact: false, artifactType: '', artifactTitle: '' };
                }
                
                // Handle objects we don't recognize - don't show [object Object]
                if (typeof parsed === 'object') {
                    // Check if it's just metadata without useful content
                    const hasOnlyMetadata = Object.keys(parsed).every(key => 
                        ['start_timestamp', 'stop_timestamp', 'flags', 'type', 'citations'].includes(key)
                    );
                    
                    if (hasOnlyMetadata || parsed.type === 'token_budget') {
                        return { content: '', isArtifact: false, artifactType: '', artifactTitle: '' };
                    }
                    
                    // For other objects, try to extract something useful
                    try {
                        const useful = JSON.stringify(parsed, null, 2);
                        return { content: `[Debug: ${useful}]`, isArtifact: false, artifactType: '', artifactTitle: '' };
                    } catch (e) {
                        return { content: '[Complex object - unable to display]', isArtifact: false, artifactType: '', artifactTitle: '' };
                    }
                }
                
                return { content: '', isArtifact: false, artifactType: '', artifactTitle: '' };
            }

            formatMarkdown(text) {
                // Simple markdown formatting
                let formatted = text;

                // Code blocks with language - wrap in collapsible container
                formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
                    const language = lang || 'code';
                    return `<div class="collapsible-code-block">
                        <div class="code-block-header" onclick="app.toggleCodeBlock('${codeId}')">
                            <span class="code-block-label">${language}</span>
                            <span class="code-block-toggle" id="${codeId}-toggle">▼</span>
                        </div>
                        <div class="code-block-content" id="${codeId}">
                            <pre><code class="language-${lang}">${code}</code></pre>
                        </div>
                    </div>`;
                });

                // Inline code
                formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // Headers
                formatted = formatted.replace(/^### (.*$)/gm, '<h3>$1</h3>');
                formatted = formatted.replace(/^## (.*$)/gm, '<h2>$1</h2>');
                formatted = formatted.replace(/^# (.*$)/gm, '<h1>$1</h1>');
                
                // Bold and italic
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                // Line breaks
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            }

            toggleConversation(event) {
                // Don't toggle if clicking on checkbox
                if (event.target.classList.contains('conversation-checkbox')) {
                    return;
                }

                const header = event.currentTarget;
                const content = header.nextElementSibling;
                const toggle = header.querySelector('.expand-toggle');

                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    toggle.classList.add('expanded');
                }
            }

            toggleArtifact(artifactId) {
                const content = document.getElementById(artifactId);
                const toggle = document.getElementById(artifactId + '-toggle');

                if (content && toggle) {
                    if (content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        toggle.classList.remove('expanded');
                    } else {
                        content.classList.add('expanded');
                        toggle.classList.add('expanded');
                    }
                }
            }

            toggleCodeBlock(codeId) {
                const content = document.getElementById(codeId);
                const toggle = document.getElementById(codeId + '-toggle');

                if (content && toggle) {
                    if (content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        toggle.classList.remove('expanded');
                    } else {
                        content.classList.add('expanded');
                        toggle.classList.add('expanded');
                    }
                }
            }

            formatDate(date) {
                if (isNaN(date)) return 'Unknown';
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            escapeHtml(text) {
                // Filter out [object Object] strings entirely
                if (text === '[object Object]') {
                    return '';
                }
                
                const div = document.createElement('div');
                div.textContent = text;
                const result = div.innerHTML;
                
                return result;
            }

            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // Selection Mode Methods
            toggleSelectionMode() {
                this.selectionMode = !this.selectionMode;
                const toggleBtn = document.getElementById('selectionToggle');
                const bulkActionsBar = document.getElementById('bulkActionsBar');
                const conversationsList = document.getElementById('conversationsList');

                if (this.selectionMode) {
                    toggleBtn.classList.add('active');
                    toggleBtn.setAttribute('data-i18n', 'disable-selection');
                    setLanguage(document.getElementById('languageSelect').value); // Update text
                    bulkActionsBar.classList.add('active');
                    conversationsList.classList.add('selection-mode');
                } else {
                    toggleBtn.classList.remove('active');
                    toggleBtn.setAttribute('data-i18n', 'enable-selection');
                    setLanguage(document.getElementById('languageSelect').value); // Update text
                    bulkActionsBar.classList.remove('active');
                    conversationsList.classList.remove('selection-mode');
                    this.clearSelection();
                }

                this.renderConversations();
            }

            toggleConversationSelection(conversationId) {
                if (this.selectedConversations.has(conversationId)) {
                    this.selectedConversations.delete(conversationId);
                } else {
                    this.selectedConversations.add(conversationId);
                }
                this.updateSelectionUI();
            }

            selectAll() {
                // Select all filtered conversations (not just visible)
                this.filteredConversations.forEach(conv => {
                    this.selectedConversations.add(conv.id);
                });

                this.updateSelectionUI();
            }

            selectAllVisible() {
                const start = (this.currentPage - 1) * this.conversationsPerPage;
                const end = start + this.conversationsPerPage;
                const visibleConversations = this.filteredConversations.slice(start, end);

                visibleConversations.forEach(conv => {
                    this.selectedConversations.add(conv.id);
                });

                this.updateSelectionUI();
            }

            clearSelection() {
                this.selectedConversations.clear();
                this.updateSelectionUI();
            }

            updateSelectionUI() {
                const count = this.selectedConversations.size;
                document.getElementById('selectionCount').textContent = `${count} selected`;

                // Update checkboxes
                const allCheckboxes = document.querySelectorAll('.conversation-checkbox');
                allCheckboxes.forEach(checkbox => {
                    const convId = checkbox.id.replace('checkbox-', '');
                    checkbox.checked = this.selectedConversations.has(convId);
                });

                // Enable/disable export button
                document.getElementById('exportSelected').disabled = count === 0;
            }

            // Export Methods
            exportSelected() {
                if (this.selectedConversations.size === 0) {
                    alert('No conversations selected');
                    return;
                }

                const selectedConvs = this.conversations.filter(conv =>
                    this.selectedConversations.has(conv.id)
                );

                const dateStr = this.getDateString();
                const filename = dateStr
                    ? `claude-conversations-selected-${dateStr}.json`
                    : 'claude-conversations-selected.json';

                this.downloadJSON(selectedConvs, filename);
            }

            exportFiltered() {
                if (this.filteredConversations.length === 0) {
                    alert('No conversations to export');
                    return;
                }

                const dateStr = this.getDateString();
                const filename = dateStr
                    ? `claude-conversations-filtered-${dateStr}.json`
                    : 'claude-conversations-filtered.json';

                this.downloadJSON(this.filteredConversations, filename);
            }

            exportSingleConversation(conversationId) {
                const conversation = this.conversations.find(conv => conv.id === conversationId);

                if (!conversation) {
                    alert('Conversation not found');
                    return;
                }

                // Create a sanitized filename from conversation title using settings
                const sanitizedTitle = conversation.name
                    .replace(/[^a-z0-9]/gi, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '')
                    .toLowerCase()
                    .substring(0, this.settings.titleLength);

                const dateStr = this.getDateString();
                const filename = dateStr
                    ? `claude-conversation-${sanitizedTitle}-${dateStr}.json`
                    : `claude-conversation-${sanitizedTitle}.json`;

                this.downloadJSON([conversation], filename);
            }

            downloadJSON(conversations, filename) {
                // Show progress indicator
                this.showProgress('Exporting...', `Preparing ${conversations.length} conversation${conversations.length === 1 ? '' : 's'}`);

                // Use setTimeout to allow UI to update
                setTimeout(() => {
                    try {
                        // Create properly formatted JSON matching Anthropic's export structure
                        const exportData = conversations.map(conv => ({
                            uuid: conv.id || conv.uuid,
                            name: conv.name,
                            created_at: conv.created_at,
                            updated_at: conv.updated_at,
                            chat_messages: conv.messages.map(msg => ({
                                uuid: msg.uuid || this.generateId(),
                                sender: msg.role,
                                text: msg.content,
                                created_at: msg.timestamp || new Date().toISOString()
                            }))
                        }));

                        // Format with proper indentation using settings
                        const jsonString = JSON.stringify(exportData, null, this.settings.jsonIndent);

                        // Create blob and download
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        // Hide progress after a short delay
                        setTimeout(() => this.hideProgress(), 500);
                    } catch (error) {
                        this.hideProgress();
                        alert('Error exporting conversations: ' + error.message);
                    }
                }, 100);
            }

            getDateString() {
                const now = new Date();
                const format = this.settings.dateFormat;

                if (format === 'none') {
                    return '';
                }

                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');

                let dateStr = '';
                switch(format) {
                    case 'DD-MM-YYYY':
                        dateStr = `${day}-${month}-${year}`;
                        break;
                    case 'MM-DD-YYYY':
                        dateStr = `${month}-${day}-${year}`;
                        break;
                    default: // YYYY-MM-DD
                        dateStr = `${year}-${month}-${day}`;
                }

                if (this.settings.includeTimestamp) {
                    dateStr += `-${hours}-${minutes}`;
                }

                return dateStr;
            }

            // Settings Methods
            loadSettings() {
                const defaultSettings = {
                    dateFormat: 'YYYY-MM-DD',
                    titleLength: 50,
                    jsonIndent: 2,
                    includeTimestamp: false
                };

                const saved = localStorage.getItem('claude-export-settings');
                this.settings = saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            }

            openSettings() {
                // Load current settings into form
                document.getElementById('dateFormat').value = this.settings.dateFormat;
                document.getElementById('titleLength').value = this.settings.titleLength;
                document.getElementById('jsonIndent').value = this.settings.jsonIndent;
                document.getElementById('includeTimestamp').checked = this.settings.includeTimestamp;

                document.getElementById('settingsModal').classList.add('active');
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }

            saveSettings() {
                // Get values from form
                this.settings = {
                    dateFormat: document.getElementById('dateFormat').value,
                    titleLength: parseInt(document.getElementById('titleLength').value),
                    jsonIndent: parseInt(document.getElementById('jsonIndent').value),
                    includeTimestamp: document.getElementById('includeTimestamp').checked
                };

                // Save to localStorage
                localStorage.setItem('claude-export-settings', JSON.stringify(this.settings));

                this.closeSettings();
            }

            resetSettings() {
                // Reset to defaults
                document.getElementById('dateFormat').value = 'YYYY-MM-DD';
                document.getElementById('titleLength').value = 50;
                document.getElementById('jsonIndent').value = 2;
                document.getElementById('includeTimestamp').checked = false;
            }

            // Progress indicator methods
            showProgress(text, subtext = '') {
                document.getElementById('progressText').textContent = text;
                document.getElementById('progressSubtext').textContent = subtext;
                document.getElementById('progressOverlay').classList.add('active');
            }

            hideProgress() {
                document.getElementById('progressOverlay').classList.remove('active');
            }
        }

        // Initialize the application
        let app; // Global app instance for onclick handlers
        document.addEventListener('DOMContentLoaded', () => {
            detectAndSetLanguage();
            app = new ClaudeExportRenderer();
        });
    </script>
</body>
</html>